{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content %}
    <h1>Créer une séance</h1>

    {% for m in app.flashes('success') %}
      <div class="flash-success">{{ m }}</div>
    {% endfor %}
    {% for m in app.flashes('error') %}
      <div class="flash-error">{{ m }}</div>
    {% endfor %}

    <form method="post" action="{{ path('admin_seance_new') }}" class="ea-new-form">
        <input type="hidden" name="_token" value="{{ csrf }}"/>

        <div class="form-group">
            <label for="cinema">Cinéma</label>
            <select id="cinema" name="cinema" required>
                <option value="">— Choisir —</option>
                {% for c in cinemas %}
                    <option value="{{ c.id }}">{{ c.nom }}</option>
                {% endfor %}
            </select>
            <small>Choisissez d'abord un cinéma.</small>
        </div>

        <div class="form-group">
            <label for="salle">Salle</label>
            <select id="salle" name="salle" required disabled>
                <option value="">— Choisir un cinéma d’abord —</option>
            </select>
        </div>

        <div class="form-group">
            <label for="film">Film</label>
            <select id="film" name="film" required>
                {% for f in films %}
                    <option value="{{ f.id }}">{{ f.titre }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="display:flex; gap:16px; flex-wrap:wrap">
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>
            </div>
            <div class="form-group">
                <label for="heure_debut">Heure de début</label>
                <input type="time" id="heure_debut" name="heure_debut" required>
            </div>
            <div class="form-group">
                <label for="heure_fin">Heure de fin</label>
                <input type="time" id="heure_fin" name="heure_fin" required>
            </div>
        </div>

        <button class="btn btn-primary">Créer</button>
        <a class="btn btn-secondary"
           href="{{ path('admin', { crudControllerFqcn: 'App\\\\Controller\\\\Admin\\\\SeanceCrudController', crudAction: 'index' }) }}">
            Retour à la liste
        </a>
    </form>

    <script>
    (function(){
      const cinéma = document.getElementById('cinema');
      const salle  = document.getElementById('salle');

      cinéma.addEventListener('change', async () => {
        salle.innerHTML = '';
        salle.disabled = true;
        const id = cinéma.value;
        if(!id){ 
          salle.innerHTML = '<option value="">— Choisir un cinéma d’abord —</option>';
          return;
        }
        const res = await fetch(`/admin/api/salles-par-cinema/${id}`);
        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0){
          salle.innerHTML = '<option value="">— Aucune salle —</option>';
          return;
        }
        const frag = document.createDocumentFragment();
        data.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.nom;
          frag.appendChild(opt);
        });
        salle.appendChild(frag);
        salle.disabled = false;
      });
    })();
    </script>
{% endblock %}
